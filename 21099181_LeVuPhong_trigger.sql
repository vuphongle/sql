use AdventureWorks2008R2

--bài 1
CREATE TABLE NHANVIEN(
	MANV NVARCHAR(50),
	TENNV NVARCHAR(30)
)

INSERT NHANVIEN VALUES ('NV001', 'PHONG')
INSERT NHANVIEN VALUES ('NV002', 'PHONG')
INSERT NHANVIEN VALUES ('NV003', 'PHONG')

SELECT * FROM NHANVIEN

CREATE TRIGGER KTMNV
ON NHANVIEN
INSTEAD OF INSERT
AS
	BEGIN
		IF EXISTS (SELECT * FROM inserted WHERE MANV IN (SELECT MANV FROM NHANVIEN))
			BEGIN
				PRINT N'MA NHAN VIEN DA TON TAI'
				ROLLBACK TRAN
			END 
		ELSE
			INSERT NHANVIEN SELECT * FROM inserted
	END

INSERT NHANVIEN VALUES ('002', 'DUNG')

SELECT *FROM NHANVIEN

--Bài 2:
CREATE TABLE NHANVIEN_TK
(
	MANV NVARCHAR(30),
	MATK NVARCHAR(30),
	SODU MONEY
)

INSERT NHANVIEN_TK VALUES('NV001', 'TK001', 100)

SELECT * FROM NHANVIEN_TK

go

CREATE TRIGGER KTMNVVMTK 
ON NHANVIEN_TK
INSTEAD OF INSERT
AS
	BEGIN
		IF EXISTS (SELECT * FROM inserted 
			WHERE (MANV IN (SELECT MANV FROM NHANVIEN_TK))
			AND (MATK IN (SELECT MATK FROM NHANVIEN_TK)))
				BEGIN
					PRINT N'MA NHAN VIEN VA MA TK DA TON TAI'
					ROLLBACK TRAN
				END
		ELSE
			INSERT NHANVIEN_TK SELECT * FROM inserted
	END

INSERT NHANVIEN_TK VALUES('NV002', 'TK001', 100)

SELECT * FROM NHANVIEN

SELECT * FROM NHANVIEN_TK

--Bài 3
CREATE TABLE TAIKHOAN 
(
	MATK NVARCHAR(30),
	TENTK NVARCHAR(30),
	PASS NVARCHAR(15)
)

INSERT TAIKHOAN VALUES ('TK001', 'TTK001', 'ABC')
INSERT TAIKHOAN VALUES ('TK004', 'TTK004', 'ABC')

ALTER TRIGGER KTKN
ON NHANVIEN_TK FOR INSERT
AS
	IF EXISTS (SELECT * FROM inserted WHERE MANV NOT IN (SELECT MANV FROM NHANVIEN))
		BEGIN
			PRINT N'MA NHAN VIEN KHONG TON TAI'
			ROLLBACK TRAN
		END
	ELSE
		BEGIN
			IF EXISTS (SELECT *FROM inserted WHERE MATK NOT IN (SELECT MATK FROM TAIKHOAN))
				BEGIN
					PRINT N'MA TAI KHOAN KHONG TON TAI'
					ROLLBACK TRAN
				END
		END
SELECT *FROM NHANVIEN
SELECT *FROM NHANVIEN_TK
SELECT *FROM TAIKHOAN

INSERT NHANVIEN_TK VALUES('NV003','TK001',200)
INSERT NHANVIEN_TK VALUES('NV001','TK004',200)

DELETE FROM NHANVIEN WHERE MANV = '002'


--Bài 4: 
CREATE TABLE LOPHOC
(
	MALOP NVARCHAR(30),
	TENLOP NVARCHAR(30),
	SISO INT
)

INSERT LOPHOC VALUES('ML001', 'DHKTPM', 0)
INSERT LOPHOC VALUES('ML002', 'DHKHMT', 0)
INSERT LOPHOC VALUES('ML003', 'DHKHDL', 0)

SELECT *FROM LOPHOC
CREATE TABLE SINHVIEN 
(
	MASV NVARCHAR(30),
	TENSV NVARCHAR(30),
	MALOP NVARCHAR(30)
)

CREATE TRIGGER CAPNHATSISO
ON SINHVIEN
FOR INSERT
AS
	BEGIN 
		UPDATE LOPHOC
		SET SISO = (SISO + 1) FROM LOPHOC p JOIN inserted o
		on p.MALOP = o.MALOP 
	END

--THỰC THI
INSERT SINHVIEN VALUES('SV001', 'VU PHONG', 'ML001')
INSERT SINHVIEN VALUES('SV002', 'VU PHONG', 'ML002')
INSERT SINHVIEN VALUES('SV003', 'PHONG VU', 'ML001'),('SV004', 'PHONG VU', 'ML002')

SELECT *FROM LOPHOC
SELECT *FROM SINHVIEN